name: Build Linux Packages

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            libgtk-3-dev

      - name: Install npm dependencies
        run: npm ci

      - name: Build Tauri app (deb, rpm, appimage)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: --target x86_64-unknown-linux-gnu

      - name: Upload deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/deb/*.deb

      - name: Upload rpm artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-rpm
          path: src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/rpm/*.rpm

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/appimage/*.AppImage

      - name: Upload to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/deb/*.deb
            src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/rpm/*.rpm
            src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/appimage/*.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-flatpak:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Flatpak dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          sudo flatpak install -y flathub org.gnome.Platform//49 org.gnome.Sdk//49

      - name: Install Linux build dependencies
        run: |
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            libgtk-3-dev

      - name: Install npm dependencies
        run: npm ci

      - name: Build application
        run: npm run tauri build -- --target x86_64-unknown-linux-gnu

      - name: Create Flatpak manifest
        run: |
          cat > com.gosh.usb-creator.yml << 'EOF'
          app-id: com.gosh.usb-creator
          runtime: org.gnome.Platform
          runtime-version: '49'
          sdk: org.gnome.Sdk
          command: gosh-usb-creator
          finish-args:
            - --share=ipc
            - --socket=fallback-x11
            - --socket=wayland
            - --device=all
            - --filesystem=host
          modules:
            - name: gosh-usb-creator
              buildsystem: simple
              build-commands:
                - install -Dm755 gosh-usb-creator /app/bin/gosh-usb-creator
                - install -Dm644 icon.png /app/share/icons/hicolor/256x256/apps/com.gosh.usb-creator.png
                - install -Dm644 com.gosh.usb-creator.desktop /app/share/applications/com.gosh.usb-creator.desktop
              sources:
                - type: file
                  path: src-tauri/target/x86_64-unknown-linux-gnu/release/gosh-usb-creator
                - type: file
                  path: src-tauri/icons/icon.png
                - type: file
                  path: com.gosh.usb-creator.desktop
          EOF

      - name: Create desktop file
        run: |
          cat > com.gosh.usb-creator.desktop << 'EOF'
          [Desktop Entry]
          Name=USB Creator
          Comment=Cross-platform USB flash drive creator
          Exec=gosh-usb-creator
          Icon=com.gosh.usb-creator
          Terminal=false
          Type=Application
          Categories=Utility;System;
          Keywords=USB;ISO;flash;drive;creator;
          EOF

      - name: Build Flatpak
        run: |
          flatpak-builder --force-clean --repo=repo build-dir com.gosh.usb-creator.yml
          flatpak build-bundle repo usb-creator.flatpak com.gosh.usb-creator

      - name: Upload Flatpak artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-flatpak
          path: usb-creator.flatpak

      - name: Upload to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: usb-creator.flatpak
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
